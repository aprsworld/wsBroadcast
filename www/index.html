<html>
<head>
<title>Weather Station Monitor</title>
<script src="res/jquery-2.1.4.min.js"></script>
<script src="res/swfobject-2.2.min.js"></script> <!-- SWFObject [Flash fallback for web_socket_js] -->
<script src="res/web-socket-js/web_socket.js"></script> <!-- git.com/gimite/web-socket-js WebSockets Compatibility Fall-Back library -->
<!-- Global Settings for web-socket-js library -->
<script>WEB_SOCKET_SWF_LOCATION = "res/web-socket-js/WebSocketMain.swf";</script>
<script src="js/wsb-client.js"></script> <!-- WebSockets Broadcast Client -->
<script>
function table_generate(data) {
	var $dtable = $('<table border=1></table>');
	for (var p in data) {
		var $drow = $('<tr></tr>');
		var $th = $('<th></th>');
		$th.text(p);
		$drow.append($th);
		// Nest Objects
		if (typeof data[p] === 'object') {
			$drow.append(table_generate(data[p]));
		} else {
			var $td = $('<td></td>');
			$td.text(data[p]);
			$drow.append($td);
		}
		$dtable.append($drow);
	}
	return $dtable;
}

function data_error (errors, delay) {
	$('#ws_status').text(errors[0] + ': Reconnecting in ' + delay + 's.');
}

function data_update (data) {
	$('#ws_status').text('Connected');
	$('#ws_update').text(data.FAIRBANKS1._bserver_.date);
	$('#ws_image').attr('src', data.FAIRBANKS1.image_url);
	$('#ws_image').attr('alt', 'Image from ' + data.FAIRBANKS1._bserver_.date);
	var tempK = data.FAIRBANKS1.sensors['External Temp'];
	var tempC = tempK - 273.15;
	var tempF = (tempC * 1.8) + 32;
	$('#ws_temp').text(Math.round(tempF) + 'Ëš F');
}

var data_object = null;
function data_start () {
	data_object = new BroadcastClient({
		callback_update: data_update,
		callback_error: data_error,
		// XXX: These are temporary
		url_ajax: 'http://cam.aprsworld.com:8888/.data',
		url_ws: 'ws://cam.aprsworld.com:1228/.data'
	});
	document.title = 'FAIRBANKS1 Station Monitor';
	$('#header').html('<h1>FAIRBANKS1 Station Monitor</h1>');
	$('#ws_status').text('Connecting...');
}
</script>
<link rel="stylesheet" type="text/css" href="styles/style.css">
</head>

<body onload="data_start();">
<div id="header">
<h1>Weather Station Monitor</h1>
</div>

<div id="content">
<img id="ws_image" src="images/disconnected.png" alt="This site requirest JavaScript!">
<br>
<table>
<tr><th>Status:</th><td id="ws_status">This site requires JavaScript!</td></tr>
<tr><th>Temperature:</th><td id="ws_temp">Unknown</td></tr>
<tr><th>Last Update:</th><td id="ws_update">Never</td></tr>
</table>
</div>

<div id="footer">
<br><hr>
&copy; Copyright 2015.<br>
ALL RIGHTS RESERVED!
</div>
</body>
</html>
