<html>
<head>
<title>WS Broadcast Test</title>
<script src="res/jquery.min.js"></script>
<script src="res/swfobject.js"></script> <!-- SWFObject [Flash fallback for web_socket_js] -->
<script src="res/web-socket-js/web_socket.js"></script> <!-- git.com/gimite/web-socket-js WebSockets Compatibility Fall-Back library -->
<script>WEB_SOCKET_SWF_LOCATION = "res/web-socket-js/WebSocketMain.swf";</script>
</head>

<body>
<div id="header">
<h1>WS Broadcast Test</h1>
</div>

<div id="content">
<div id="wsdata">
<strong>THIS SITE REQUIRES JAVASCRIPT!</strong>
</div>
</div>

<div id="footer">
<br /><hr />
&copy; Copyright 2015.<br />
ALL RIGHTS RESERVED!
</div>
</body>
<script>
<!-- BUG: I'm not sure this is kosher after the body tag -->
function table_generate(data) {
	var $dtable = $('<table border=1></table>');
	var $drow = $('<tr></tr>');
	for (var p in data) {
		$drow.append('<th>' + p + ':</th>');
		// Nest Objects
		if (typeof data[p] === 'object') {
			// TODO: Arrays?
			$drow.append(table_generate(data[p]));
		} else {
			// BUG: Escape Data
			$drow.append('<td>' + data[p] + '</td>');
		}
		$dtable.append($drow);
	}
	return $dtable;
}

var poll_frequency = 30;
var delay = 0;
var delay_max = 60 * 5;
var delay_inc = 10;
function ajax_connect () {
	$.ajax("http://" + window.location.hostname + ":8888/.data", {
		cache: 'false',
		dataType: 'json',
		error: function (XHR, status, error) {
			delay = (delay >= delay_max)
				? delay_max : delay + delay_inc;
			$('#wsdata').html("<strong>AJAX Error:</strong>"
				+ status + ": " + error
				+ "<br><em>Retrying in " + delay + "s.</em>");
			setTimeout(ajax_connect, delay * 1000);
		},
		success: function (data, status, XHR) {
			$('#wsdata').html(table_generate(data));
			setTimeout(ajax_connect, poll_frequency * 1000);
		}
	});
}

function ws_connect () {
	$('#wsdata').html("<strong>Connecting...</strong>");
	var ws = null;

	try {
		ws = new WebSocket("ws://" + window.location.hostname + ":1228/");
	} catch (e) {
		ajax_connect();
		return;
	}
	if (!ws) {
		ajax_connect();
		return;
	}

	ws.onopen = function() {
		delay = 0;
		$('#wsdata').html("<strong>Connected:</strong>"
			+ " Waiting for data.");
	}

	ws.onmessage = function(m) {
		var data = JSON.parse(m.data); // BUG: XXX:
		$('#wsdata').html(table_generate(data));
	}

	ws.onclose = function() {
		$('#wsdata').html("<strong>Disconnected:</strong>"
			+ " Reconnecting in " + delay + "s.");
		ws = null;
		setTimeout(ws_connect, delay * 1000);
	}

	ws.onerror = function(e) {
		$('#wsdata').html("<strong>WebSockets Error!</strong>");
		delay = (delay >= delay_max)
			? delay_max : delay + delay_inc;
	}
}

ws_connect();
</script>
</html>
