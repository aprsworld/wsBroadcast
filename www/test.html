<html>
<head>
<title>WS Broadcast Test</title>
<script src="res/jquery.min.js"></script>
<script src="res/swfobject.js"></script> <!-- SWFObject [Flash fallback for web_socket_js] -->
<script src="res/web-socket-js/web_socket.js"></script> <!-- git.com/gimite/web-socket-js WebSockets Compatibility Fall-Back library -->
<script>WEB_SOCKET_SWF_LOCATION = "res/web-socket-js/WebSocketMain.swf";</script>
</head>

<body>
<div id="header">
<h1>WS Broadcast Test</h1>
</div>

<div id="content">
<div id="wsdata">
<strong>THIS SITE REQUIRES JAVASCRIPT!</strong>
</div>
</div>

<div id="footer">
<hr />
&copy; Copyright 2015.<br />
ALL RIGHTS RESERVED!
</div>
</body>
<script>
<!-- BUG: I'm not sure this is kosher after the body tag -->
function table_generate(data) {
	var $dtable = $('<table border=1></table>');
	var $drow = $('<tr></tr>');
	for (var p in data) {
		$drow.append('<th>' + p + ':</th>');
		// Nest Objects
		if (typeof data[p] === 'object') {
			// TODO: Arrays?
			$drow.append(table_generate(data[p]));
		} else {
			// BUG: Escape Data
			$drow.append('<td>' + data[p] + '</td>');
		}
		$dtable.append($drow);
	}
	return $dtable;
}

var ws_delay = 0;
var ws = null;
function ws_connect () {
	if (ws) {
		return;
	}

	$('#wsdata').html("<strong>Connecting...</strong>");
	ws = new WebSocket("ws://" + window.location.hostname + ":1228/");

	ws.onopen = function() {
		ws_delay = 0;
		$('#wsdata').html("<strong>Connected:</strong> Waiting for data.");
	}

	ws.onmessage = function(m) {
		var data = JSON.parse(m.data); // BUG:
		$('#wsdata').html(table_generate(data));
	}

	ws.onclose = function() {
		$('#wsdata').html("<strong>Disconnected:</strong> Reconnecting in " + ws_delay + "s.");
		ws = null;
		setTimeout(ws_connect, ws_delay * 1000);
	}

	ws.onerror = function(e) {
		$('#wsdata').html("<strong>WebSockets Error!</strong>");
		ws_delay = ws_delay >= 60 ? 60 : ws_delay + 10;
	}
}

ws_connect();
</script>
</html>
